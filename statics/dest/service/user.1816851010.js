!function(t){"use strict";var n=angular.module("jt.service.user",[]);n.factory("user",["$rootScope","$http","$q","debug",function(t,n,r,e){function o(t){var r=n.post(a.url,t);return r.then(function(n){i=null,u(n,t.type)}),r}function u(n,r){s=n.data,s.deviation=_.now()-s.now,e("user:%j",s),angular.forEach(c,function(t){t.resolve(angular.copy(s))}),c.length=0,r&&t.$broadcast("user",r)}e=e("user");var i,s,c=[],a={url:"/user?cache=false",session:function(){var t=r.defer();return s?t.resolve(s):i?c.push(t):(this._getSession(),c.push(t)),t.promise},_getSession:function(){i=n.get(a.url),i.then(function(t){u(t)},function(t){angular.forEach(c,function(n){n.reject(t)}),c.length=0})},register:function(t,n){var r={type:"register",account:t,password:CryptoJS.SHA1(n).toString()};return o(r)},login:function(t,n){var r=CryptoJS.SHA1(n).toString();n=CryptoJS.SHA1(r+s.code).toString();var e={type:"login",account:t,password:n};return o(e)},logout:function(){var t=n["delete"](a.url);return t.then(function(t){i=null,u(t,"logout")}),t}};return a}])}(this);